<html>
    <head>
      <meta name="viewport" content="width=device-width, initial-scale=1">
      <meta http-equiv="content-language" content="en" />
      <link rel="icon" href="data:,">
      <link rel="stylesheet" type="text/css" href="/css/app.css">

      <script src="/js/app.js"></script>
      <script>var buildRev = "%BUILD_REV%";</script>

      <title>Analysis</title>
        
    </head>
    <body>
      <main id="analysis">
        <div id="dynamicanalysisitems">
          <table>
            <thead>
              <tr>
                <th style="width: 161px;">Name</th>
                <th style="width: 70px;">Frame ID</th>
                <th style="width: 64px;">Start Bit</th>
                <th style="width: 80px;">Bit Length</th>
                <th style="width: 58px;">Factor</th>
                <th style="width: 100px;">Signal Offset</th>
                <th style="width: 72px;">Is Signed</th>
                <th style="width: 96px;">Little Endian</th>
                <th style="width: 68px;">Value</th>
                <th style="width: 50px;">Action</th>
              </tr>
            </thead>
            <tbody>
              <tr id="loading">
                <td colspan="10" style="text-align:left !important">Loading...</td>
              </tr>
            </tbody>
            <tfoot>
              <tr id="noitems" class="hidden">
                <td colspan="10" style="text-align:left !important">No items</td>
              </tr>
              <tr id="rowtemplate" class="hidden">
                <td data-title="Name">
                  <input class="name" name="name" value="" maxlength="20">
                </td>
                <td data-title="Frame ID">
                  <input class="frameid" name="frameid" value="">
                </td>
                <td data-title="Start Bit">
                  <input class="startbit" name="startbit" value="" type="number">
                </td>
                <td data-title="Bit Length">
                  <input class="bitlength" name="bitlength" value="" type="number">
                </td>
                <td data-title="Factor">
                  <input class="factor" name="factor" value="">
                </td>
                <td data-title="Signal Offset">
                  <input class="signaloffset" name="signaloffset" value="">
                </td>
                <td data-title="Is Signed">
                  <input class="issigned" name="issigned" type="checkbox">
                </td>
                <td data-title="Little Endian">
                  <input class="littleendian" name="littleendian" type="checkbox">
                </td>
                <td class="value" data-title="Value"> --- </td>
                <td data-title="Action">
                  <a class="copy" alt="Copy" title="Copy"><img style="vertical-align: text-top;" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAIpSURBVDjLddM9aFRBFIbh98zM3WyybnYVf4KSQjBJJVZBixhRixSaShtBMKUoWomgnaCxsJdgIQSstE4nEhNREgyoZYhpkogkuMa4/3fuHIu7gpLd00wz52POMzMydu/Dy958dMwYioomIIgqDa+VnWrzebNUejY/NV6nQ8nlR4ufXt0fzm2WgxUgqBInAWdhemGbpcWNN9/XN27PPb1QbRdgjEhPqap2ZUv5+iOwvJnweT1mT5djZKjI6Ej/udz+wt1OJzAKYgWyDjJWyFghmzFsbtcY2gsTJwv09/Vc7RTgAEQgsqAKaoWsM8wu/z7a8B7vA8cHD3Fr+ktFgspO3a+vrdVfNEulJ/NT4zWngCBYY1oqSghKI465fvYwW+VAatPX07IZmF7YfrC0uDE8emPmilOFkHYiBKxAxhmSRPlZVVa2FGOU2Ad2ap4zg92MDBXJZczFmdflx05VEcAZMGIIClZASdesS2cU/dcm4sTBArNzXTcNakiCb3/HLRsn4Fo2qyXh3WqDXzUlcgYnam3Dl4Hif82dbOiyiBGstSjg4majEpl8rpCNUQUjgkia0M5GVAlBEBFUwflEv12b/Hig6SmA1iDtzhcsE6eP7LIxAchAtwNVxc1MnhprN/+lh0txErxrPZVdFdRDEEzHT6LWpTbtq+HLSDDiOm2o1uqlyOT37bIhHdKaXoL6pqhq24Dzd96/tUYGwPSBVv7atFglaFIu5KLuPxeX/xsp7aR6AAAAAElFTkSuQmCC"></a>
                  <a class="save" alt="Save" title="Save"><img style="vertical-align: text-top;" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAH+SURBVBgZBcE9i11VGAbQtc/sO0OCkqhghEREAwpWAWUg8aMVf4KFaJEqQtAipTZWViKiCGOh2Ap2gmJhlSIWFsFOxUK0EsUM3pl79n4f12qHb3z3Fh7D83gC95GOJsDe0ixLk5Qq/+xv/Lw9Xd+78/HLX3Y8fXTr2nWapy4eCFKxG7Fby97SnDlYtMbxthyfzHO//nl85fNvfvnk8MbX5xa8IHx1518Vkrj54Q+qQms2vVmWZjdiu5ZR2rT01166/NCZg/2PFjwSVMU6yjoC1oq+x6Y3VbHdlXWExPd379nf7Nmejv2Os6OC2O4KLK0RNn3RNCdr2Z5GJSpU4o+/TkhaJ30mEk5HwNuvX7Hpi76wzvjvtIwqVUSkyjqmpHS0mki8+9mPWmuWxqYvGkbFGCUAOH/+QevYI9GFSqmaHr5wkUYTAlGhqiRRiaqiNes6SOkwJwnQEqBRRRJEgkRLJGVdm6R0GLMQENE0EkmkSkQSVVMqopyuIaUTs0J455VLAAAAAODW0U/GiKT0pTWziEj44PZ1AAAAcPPqkTmH3QiJrlEVDXDt0qsAAAAAapa5BqUnyaw0Am7//gUAAAB49tEXzTmtM5KkV/y2G/X4M5fPao03n/sUAAAAwIX7y5yBv9vhjW/fT/IkuSp5gJKElKRISYoUiSRIyD1tufs/IXxui20QsKIAAAAASUVORK5CYII="></a>
                  <a class="delete" alt="Delete" title="Delete"><img style="vertical-align: text-top;" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAJdSURBVDjLpZP7S1NhGMf9W7YfogSJboSEUVCY8zJ31trcps6zTI9bLGJpjp1hmkGNxVz4Q6ildtXKXzJNbJRaRmrXoeWx8tJOTWptnrNryre5YCYuI3rh+8vL+/m8PA/PkwIg5X+y5mJWrxfOUBXm91QZM6UluUmthntHqplxUml2lciF6wrmdHriI0Wx3xw2hAediLwZRWRkCPzdDswaSvGqkGCfq8VEUsEyPF1O8Qu3O7A09RbRvjuIttsRbT6HHzebsDjcB4/JgFFlNv9MnkmsEszodIIY7Oaut2OJcSF68Qx8dgv8tmqEL1gQaaARtp5A+N4NzB0lMXxon/uxbI8gIYjB9HytGYuusfiPIQcN71kjgnW6VeFOkgh3XcHLvAwMSDPohOADdYQJdF1FtLMZPmslvhZJk2ahkgRvq4HHUoWHRDqTEDDl2mDkfheiDgt8pw340/EocuClCuFvboQzb0cwIZgki4KhzlaE6w0InipbVzBfqoK/qRH94i0rgokSFeO11iBkp8EdV8cfJo0yD75aE2ZNRvSJ0lZKcBXLaUYmQrCzDT6tDN5SyRqYlWeDLZAg0H4JQ+Jt6M3atNLE10VSwQsN4Z6r0CBwqzXesHmV+BeoyAUri8EyMfi2FowXS5dhd7doo2DVII0V5BAjigP89GEVAtda8b2ehodU4rNaAW+dGfzlFkyo89GTlcrHYCLpKD+V7yeeHNzLjkp24Uu1Ed6G8/F8qjqGRzlbl2H2dzjpMg1KdwsHxOlmJ7GTeZC/nesXbeZ6c9OYnuxUc3fmBuFft/Ff8xMd0s65SXIb/gAAAABJRU5ErkJggg=="></a>
                </td>
              </tr>
            </tfoot>
          </table>
          <br>
          <button id="new">New Item</button>
        </div>
      </main>
      
      <script>
        const analysisEl = document.getElementById('analysis');
        
        if (analysisEl) {
          document.addEventListener('paste', (event) => {
            let paste = (event.clipboardData || window.clipboardData).getData('text');
            var parsedJson = false;
            try {
                parsedJson = JSON.parse(paste);
            } catch (e) {
            }
            
            if (parsedJson !== false) {
              
              //Check if this is the json we are looking for
              if ("n" in parsedJson && 
                  "fid" in parsedJson &&
                  "sb" in parsedJson &&
                  "bl" in parsedJson &&
                  "f" in parsedJson &&
                  "so" in parsedJson &&
                  "s" in parsedJson &&
                  "bo" in parsedJson &&
                  "v" in parsedJson) {
                //This looks like what we want.  Lets deal with it.
                var itemName = parsedJson.n;
                
                //Lets see if we already have this name and need to change its values
                var alertString = "";
                var foundItemRow = document.querySelector("tr#item" + itemName);
                if (foundItemRow) {
                  //An existing entry.  Lets update it.
                  alertString = itemName + ' analysis item has been updated.  Please save it if you wish to keep the changes.';
                  
                } else {
                  //A new entry.  Lets add it
                  createNewItem();
                  foundItemRow = document.querySelector("tr#----new----");
                  foundItemRow.querySelector('input.name').value = itemName;
                  
                  alertString = itemName + ' analysis item has been created.  Please save it if you wish to keep the changes.'
                }
                
                foundItemRow.querySelector('input.name').value = itemName;
                foundItemRow.querySelector('input.frameid').value = '0x' + decToHex(parsedJson.fid, 3);
                foundItemRow.querySelector('input.startbit').value = parsedJson.sb;
                foundItemRow.querySelector('input.bitlength').value = parsedJson.bl;
                foundItemRow.querySelector('input.factor').value = parsedJson.f;
                foundItemRow.querySelector('input.signaloffset').value = parsedJson.so;
                foundItemRow.querySelector('input.issigned').checked = parsedJson.s == true;
                foundItemRow.querySelector('input.littleendian').checked = parsedJson.bo == true;
                
                event.preventDefault();      
                
                setTimeout("alert('" + alertString + "');", 0);
              } else {
                //This isn't the json you are looking for  
              }
              return;
            }
          });
          
          
          
          const analysisNewEl = analysisEl.querySelector('button#new');
          
          let itemsToLoad = [];
          
          const getItemsRecursive = () => {
              // terminate if array exhausted
              if (itemsToLoad.length === 0) {
                updateLoad();
                setInterval(updateLoad, 2000);
                return;
              }

              // pop top value
              var itemId = itemsToLoad[0];
              itemsToLoad.shift();
          
              // ajax request
              getJSON('/analysis_info?item=' + itemId).then(data => {
                
                let itemRow = analysis.querySelector("tr#item" + itemId);
                
                itemRow.querySelector('input.frameid').value = '0x' + decToHex(data.frameid, 3);
                itemRow.querySelector('input.startbit').value = data.startBit;
                itemRow.querySelector('input.bitlength').value = data.bitLength;
                itemRow.querySelector('input.factor').value = data.factor;
                itemRow.querySelector('input.signaloffset').value = data.signalOffset;
                itemRow.querySelector('input.issigned').checked = data.isSigned == true;
                itemRow.querySelector('input.littleendian').checked = data.byteOrder == true;
                
                let saveLinkEl = itemRow.querySelector('a.save');
                saveLinkEl.onclick = function () { saveItem(this) };
                addClass(saveLinkEl, 'clickable');
                
                let deleteLinkEl = itemRow.querySelector('a.delete');
                deleteLinkEl.onclick = function () { deleteItem(this) };
                addClass(deleteLinkEl, 'clickable');

                let copyLinkEl = itemRow.querySelector('a.copy');
                copyLinkEl.onclick = function () { copyItem(this) };
                addClass(copyLinkEl, 'clickable');

                let inputItems = itemRow.querySelectorAll('input');
                inputItems.forEach(inputItem => {
                  inputItem.disabled = false;
                });
                  
                // call completed - so start next request
                getItemsRecursive();
              });
          }
          
          getJSON('/analysis_load').then(data => {
            let haveItems = false;
            
            const itemIds = Object.keys(data);
            
            analysis.querySelector('tr#loading').remove();
            
            itemIds.forEach(itemId => {
              let itemdetails = data[itemId];
              
              itemsToLoad.push(itemId);
              
              let itemRow = analysis.querySelector("tfoot tr#rowtemplate").cloneNode(true);
              itemRow.setAttribute('id', "item"+itemId);
              show(itemRow);
              
              inputBoxEl = itemRow.querySelector('input.name');
              inputBoxEl.value = itemId;
              
              let inputItems = itemRow.querySelectorAll('input');
              inputItems.forEach(inputItem => {
                inputItem.disabled = true;
              });

              analysis.querySelector('table tbody').appendChild(itemRow);
            });
            
            if (!itemIds || itemIds.length === 0) {
                show(analysis.querySelector('tr#noitems'))
            }
            
            getItemsRecursive();
          });
          
          const createNewItem = () => {
            let itemRow = analysis.querySelector("tfoot tr#rowtemplate").cloneNode(true);

            itemRow.setAttribute('id', '----new----');
            let saveLinkEl = itemRow.querySelector('a.save');
            saveLinkEl.onclick = function () { saveItem(this) };
            addClass(saveLinkEl, 'clickable');
            
            let deleteLinkEl = itemRow.querySelector('a.delete');
            deleteLinkEl.onclick = function () { deleteItem(this) };
            addClass(deleteLinkEl, 'clickable');

            let copyLinkEl = itemRow.querySelector('a.copy');
            copyLinkEl.onclick = function () { copyItem(this) };
            addClass(copyLinkEl, 'clickable');
            
            itemRow.querySelector('input.littleendian').checked = true;

            show(itemRow);

            analysis.querySelector('table tbody').appendChild(itemRow);
            hide(analysis.querySelector('tr#noitems'));
          }
          
          const deleteItem = (rowhref) => {
            const rowToDelete = rowhref.parentElement.parentElement;
            
            if (rowToDelete.getAttribute('id') === "----new----") {
              rowToDelete.remove();
            } else {
              const shouldDelete = confirm('Are you sure you want to delete this item?  If any displays are referencing it they will stop being able to display this data point.');
          
              if (shouldDelete) {
                let postInfo = new FormData();
                postInfo.append('name', rowToDelete.getAttribute('id').replace(/^item/, ''));
                
                postData('/analysis_delete', postInfo).then(() => {
                  window.location = "/analysis";
                });
              }
            }
          }
          
          const copyItem = (rowhref) => {
            const rowToWorkOn = rowhref.parentElement.parentElement;
            
            //Lets generate json from this row's data
            var jsonToCopy = {};
            jsonToCopy['n'] = rowToWorkOn.querySelector('input.name').value;
            jsonToCopy['fid'] = hexToDec(rowToWorkOn.querySelector('input.frameid').value.substr(2));
            jsonToCopy['sb'] = Number(rowToWorkOn.querySelector('input.startbit').value);
            jsonToCopy['bl'] = Number(rowToWorkOn.querySelector('input.bitlength').value);
            jsonToCopy['f'] = Number(rowToWorkOn.querySelector('input.factor').value);
            jsonToCopy['so'] = Number(rowToWorkOn.querySelector('input.signaloffset').value);
            jsonToCopy['s'] = rowToWorkOn.querySelector('input.issigned').checked;
            jsonToCopy['bo'] = rowToWorkOn.querySelector('input.littleendian').checked;
            jsonToCopy['v'] = 1;
            
            var id = "mycustom-clipboard-textarea-hidden-id";
            var existsTextarea = document.getElementById(id);
        
            if(!existsTextarea){
                var textarea = document.createElement("textarea");
                textarea.id = id;
                // Place in top-left corner of screen regardless of scroll position.
                textarea.style.position = 'fixed';
                textarea.style.top = 0;
                textarea.style.left = 0;
        
                // Ensure it has a small width and height. Setting to 1px / 1em
                // doesn't work as this gives a negative w/h on some browsers.
                textarea.style.width = '1px';
                textarea.style.height = '1px';
        
                // We don't need padding, reducing the size if it does flash render.
                textarea.style.padding = 0;
        
                // Clean up any borders.
                textarea.style.border = 'none';
                textarea.style.outline = 'none';
                textarea.style.boxShadow = 'none';
        
                // Avoid flash of white box if rendered for any reason.
                textarea.style.background = 'transparent';
                document.querySelector("body").appendChild(textarea);
                
                existsTextarea = document.getElementById(id);
            }

            existsTextarea.value = JSON.stringify(jsonToCopy, null, '\t');
            existsTextarea.select();
              
            try {
                var status = document.execCommand('copy');
                if(!status){
                    console.error("Cannot copy text");
                }else{
                    alert(jsonToCopy['n'] + ' analysis item has been copied to your clipboard.');
                }
            } catch (err) {
                console.err('Unable to copy.', err);
            }
            existsTextarea.value = "";
          }
          
          const saveItem = (rowhref) => {
            let rowToWorkOn = rowhref.parentElement.parentElement;
            const newName = rowToWorkOn.querySelector('input.name').value;
            
            //Check the format of newName to make sure its valid chars for what we use it for
            if (/^[a-zA-Z0-9-_]+$/.test(newName)) {

              let foundNameCount = 0;
              analysis.querySelectorAll('input.name').forEach(obj => {
                if (obj.value == newName) {
                  foundNameCount++;
                }
              });
  
              if (foundNameCount == 1) {
                let postInfo = new FormData();
                postInfo.append('state', rowToWorkOn.getAttribute('id') === "----new----" ? 'new' : 'update');
                postInfo.append('origName', rowToWorkOn.getAttribute('id').replace(/^item/, ''));
                postInfo.append('name', newName);
                postInfo.append('frameid', hexToDec(rowToWorkOn.querySelector('input.frameid').value.substr(2)));
                postInfo.append('startbit', Number(rowToWorkOn.querySelector('input.startbit').value));
                postInfo.append('bitlength', Number(rowToWorkOn.querySelector('input.bitlength').value));
                postInfo.append('factor', Number(rowToWorkOn.querySelector('input.factor').value));
                postInfo.append('signaloffset', Number(rowToWorkOn.querySelector('input.signaloffset').value));
                postInfo.append('issigned', rowToWorkOn.querySelector('input.issigned').checked);
                postInfo.append('littleendian', rowToWorkOn.querySelector('input.littleendian').checked);
                
                postData('/analysis_save', postInfo).then(() => {
                  window.location = "/analysis";
                });
              } else {
                alert('You can\'t have duplicate names. Please choose a unique name');
              }
            } else {
              alert('Please ensure that the name is only made of up upper and lower case letters, numbers, or - or _ characters');
            }
          }

          
          const updateLoad = () => {
            getJSON('/analysis_update').then(data => {
              Object.keys(data).forEach(itemId => {
                let itemRow = analysis.querySelector('tr#item' + itemId + ' td.value');
                if (itemRow) {
                  itemRow.innerHTML = data[itemId];
                }
              });
            });
          }

          analysisNewEl.onclick = () => createNewItem();
        }
      </script>
    </body>
</html>